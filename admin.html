<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Control - Gruken</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

    <style>
        :root {
            --primary: #333;
            --success: #28a745;
            --warning: #ffc107;
            --danger: #dc3545;
            --info: #17a2b8;
            --light: #f4f4f4;
        }
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            padding: 20px; 
            background: transparent !important; 
            color: #333; 
            margin: 0; 
        }
        .container { 
            max-width: 1200px; /* Un poco m√°s ancho para que entren todas las columnas */
            margin: auto; 
            background: rgba(255, 255, 255, 0.7) !important; 
            backdrop-filter: blur(10px);
            padding: 30px; 
            border-radius: 12px; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.1); 
        }
        .header-admin { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid var(--light); padding-bottom: 15px; margin-bottom: 20px; flex-wrap: wrap; gap: 10px; }
        
        .export-buttons { display: flex; gap: 10px; }
        .btn-export { border: none; padding: 10px 15px; border-radius: 5px; cursor: pointer; color: white; font-weight: bold; transition: 0.3s; display: flex; align-items: center; gap: 5px; }
        .btn-excel { background: #1d6f42; }
        .btn-pdf { background: #b30b00; }
        .btn-logout { background: #dc3545; }
        .btn-export:hover { opacity: 0.8; transform: translateY(-2px); }

        .stats-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 25px; }
        .card { padding: 15px; border-radius: 8px; border-left: 5px solid var(--primary); background: #fff; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .card.low-stock { border-left-color: var(--danger); }

        .search-bar { margin-bottom: 20px; display: flex; gap: 10px; }
        input[type="text"] { flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 5px; }

        /* Estilos de la tabla y los inputs */
        .table-responsive { width: 100%; overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; background: white; min-width: 900px; }
        th, td { padding: 10px; border-bottom: 1px solid #eee; text-align: left; vertical-align: middle; }
        th { background: var(--primary); color: white; font-size: 14px; }
        
        .form-control { padding: 8px; border: 1px solid #ccc; border-radius: 4px; width: 100%; box-sizing: border-box; }
        .img-preview { width: 40px; height: 40px; object-fit: cover; border-radius: 4px; margin-right: 5px; vertical-align: middle; border: 1px solid #ddd; }
        
        .col-img { width: 150px; }
        .col-titulo { width: 200px; font-weight: bold; }
        .col-talle { width: 80px; }
        .col-color { width: 100px; }
        .col-stock { width: 80px; text-align: center; }
        .col-precio { width: 100px; }
        
        .badge-danger { display: inline-block; margin-top: 5px; padding: 4px 8px; border-radius: 12px; font-size: 0.75rem; background: #ffebee; color: var(--danger); font-weight: bold; }
        
        .btn-update { background: var(--success); color: white; border: none; padding: 10px 15px; cursor: pointer; border-radius: 4px; font-weight: bold; display: flex; gap: 5px; align-items: center; width: 100%; justify-content: center; }
        .btn-update:hover { background: #218838; }
    </style>
</head>
<body>

    <div id="overlay-login" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: transparent; z-index: 9998;"></div>

    <div id="pantalla-login" style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 90%; max-width: 400px; background: rgba(0, 0, 0, 0.75); backdrop-filter: blur(8px); padding: 30px; border-radius: 12px; box-shadow: 0 15px 35px rgba(0,0,0,0.5); border: 1px solid rgba(255, 255, 255, 0.1); z-index: 9999; text-align: center; color: white;">
        <h2 style="color: white; margin-bottom: 20px;">üîê Acceso Administrativo</h2>
        <input type="email" id="email-admin" placeholder="Tu correo de Supabase" style="width: 90%; padding: 12px; margin: 10px 0; border: none; border-radius: 5px; font-family: inherit; background: rgba(255, 255, 255, 0.9); color: #333;">
        <input type="password" id="pass-admin" placeholder="Tu contrase√±a" style="width: 90%; padding: 12px; margin: 10px 0; border: none; border-radius: 5px; font-family: inherit; background: rgba(255, 255, 255, 0.9); color: #333;">
        <button onclick="iniciarSesion()" style="padding: 12px 20px; background: #28a745; color: white; border: none; cursor: pointer; border-radius: 5px; width: 95%; margin-top: 15px; font-size: 16px; font-weight: bold; transition: 0.3s;">Entrar al Inventario</button>
    </div>

    <div id="panel-admin" style="display: block;">
        <div class="container">
            <div class="header-admin">
                <div>
                    <h1><i class="fas fa-boxes"></i> Inventario Gruken</h1>
                </div>
                <div class="export-buttons">
                    <button onclick="exportarExcel()" class="btn-export btn-excel">
                        <i class="fas fa-file-excel"></i> Excel
                    </button>
                    <button onclick="exportarPDF()" class="btn-export btn-pdf">
                        <i class="fas fa-file-pdf"></i> PDF
                    </button>
                    <button onclick="cerrarSesion()" class="btn-export btn-logout">
                        <i class="fas fa-sign-out-alt"></i> Salir
                    </button>
                </div>
            </div>

            <div class="stats-cards">
                <div class="card" id="stat-total-prods">Esperando acceso...</div>
                <div class="card low-stock" id="stat-low-stock">Esperando acceso...</div>
            </div>

            <div class="search-bar">
                <input type="text" id="busqueda" placeholder="Buscar por nombre, talle, color..." onkeyup="filtrarProductos()">
            </div>

            <div class="table-responsive">
                <div id="tabla-inventario" style="max-height: 600px; overflow-y: auto;">
                    <p style="text-align: center; padding: 20px; color: #666;">Inicia sesi√≥n para ver y editar los productos.</p>
                </div>
            </div>
        </div>
    </div> 
    
    <script>
        // Configuraci√≥n de Supabase 
        const supabaseUrl = 'https://pvniwivsxluujijyqqpc.supabase.co';
        const supabaseKey = 'sb_publishable_ss0VcJwu1wR5OVrNn2aYUw_sGG4HiJh';
        const _supabase = supabase.createClient(supabaseUrl, supabaseKey);

        let productosLocal = []; 

        // --- FUNCI√ìN DE LOGIN Y CERRAR SESI√ìN ---
        async function iniciarSesion() {
            const email = document.getElementById('email-admin').value;
            const password = document.getElementById('pass-admin').value;

            const { data, error } = await _supabase.auth.signInWithPassword({
                email: email,
                password: password
            });

            if (error) {
                alert("Acceso denegado: Correo o contrase√±a incorrectos. ‚ùå");
            } else {
                document.getElementById('pantalla-login').style.display = 'none';
                document.getElementById('overlay-login').style.display = 'none'; 
                
                document.getElementById('tabla-inventario').innerHTML = "<p style='text-align: center;'>Cargando inventario...</p>";
                cargarInventario();
            }
        }

        async function cerrarSesion() {
            await _supabase.auth.signOut();
            localStorage.removeItem('admin'); 
            window.location.replace('index.html'); 
        }

        // --- CARGA Y RENDERIZADO ---
        async function cargarInventario() {
            const { data, error } = await _supabase
                .from('productos')
                .select('*')
                .order('titulo', { ascending: true });

            if (error) return;
            productosLocal = data;
            renderizarTabla(data);
            actualizarEstadisticas(data);
        }

        function renderizarTabla(productos) {
            let html = `<table><thead><tr>
                <th>Imagen (Ruta/URL)</th>
                <th>Nombre del Producto</th>
                <th>Talle</th>
                <th>Color</th>
                <th>Stock / Cant.</th>
                <th>Precio ($)</th>
                <th>Acci√≥n</th>
            </tr></thead><tbody>`;

            productos.forEach((p, index) => {
                // Generamos un ID √∫nico y limpio para cada fila para no tener problemas con los espacios en los talles o colores
                const rowId = `row-${index}`;
                // Aseguramos que la propiedad imagen exista para no dar error de "undefined"
                const imagenStr = p.imagen ? p.imagen : '';

                html += `
                    <tr class="fila-producto" data-search="${p.titulo} ${p.talla} ${p.color}">
                        
                        <td class="col-img">
                            <div style="display:flex; align-items:center;">
                                <img src="${imagenStr}" onerror="this.src='https://via.placeholder.com/40?text=IMG'" class="img-preview">
                                <input type="text" id="img-${rowId}" class="form-control" value="${imagenStr}" placeholder="img/foto.jpg">
                            </div>
                        </td>
                        
                        <td class="col-titulo">
                            <input type="text" id="titulo-${rowId}" class="form-control" value="${p.titulo}">
                        </td>
                        
                        <td class="col-talle">
                            <input type="text" id="talla-${rowId}" class="form-control" value="${p.talla}">
                        </td>
                        
                        <td class="col-color">
                            <input type="text" id="color-${rowId}" class="form-control" value="${p.color}">
                        </td>
                        
                        <td class="col-stock">
                            <input type="number" id="stock-${rowId}" class="form-control" value="${p.stock}">
                            ${p.stock < 5 ? '<span class="badge-danger">Cr√≠tico</span>' : ''}
                        </td>
                        
                        <td class="col-precio">
                            <input type="number" id="precio-${rowId}" class="form-control" value="${p.precio}">
                        </td>
                        
                        <td>
                            <button class="btn-update" onclick="actualizarProducto(event, '${rowId}', '${p.id}', '${p.talla}', '${p.color}')">
                                <i class="fas fa-save"></i> Guardar
                            </button>
                        </td>
                    </tr>`;
            });
            document.getElementById('tabla-inventario').innerHTML = html + '</tbody></table>';
        }

        // --- ACTUALIZACI√ìN DE DATOS ---
        async function actualizarProducto(event, rowId, idSupabase, oldTalla, oldColor) {
            // Obtenemos todos los valores nuevos de los inputs usando el rowId
            const nuevaImagen = document.getElementById(`img-${rowId}`).value;
            const nuevoTitulo = document.getElementById(`titulo-${rowId}`).value;
            const nuevaTalla = document.getElementById(`talla-${rowId}`).value;
            const nuevoColor = document.getElementById(`color-${rowId}`).value;
            const nuevoStock = document.getElementById(`stock-${rowId}`).value;
            const nuevoPrecio = document.getElementById(`precio-${rowId}`).value;

            // Cambiamos visualmente el bot√≥n a "Guardando..."
            const btn = event.target.closest('button');
            const btnOriginalHTML = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ...';
            btn.style.background = "#ffc107";
            btn.style.color = "#000";

            // Enviamos todo a Supabase
            const { error } = await _supabase
                .from('productos')
                .update({ 
                    imagen: nuevaImagen,
                    titulo: nuevoTitulo, 
                    talla: nuevaTalla,
                    color: nuevoColor,
                    stock: parseInt(nuevoStock), 
                    precio: parseInt(nuevoPrecio) 
                })
                // BUSCAMOS LA FILA USANDO LOS DATOS VIEJOS POR SI ACASO EL USUARIO CAMBI√ì EL TALLE O EL COLOR
                .eq('id', idSupabase)
                .eq('talla', oldTalla)
                .eq('color', oldColor);

            if (!error) {
                // √âxito
                btn.style.background = "#2ecc71";
                btn.style.color = "#fff";
                btn.innerHTML = '<i class="fas fa-check"></i> Listo';
                
                setTimeout(() => {
                    cargarInventario(); // Recargamos la tabla para asentar los nuevos datos base
                }, 1000);
            } else {
                // Error
                btn.style.background = "#dc3545";
                btn.style.color = "#fff";
                btn.innerHTML = '<i class="fas fa-times"></i> Error';
                alert("Hubo un error al guardar: " + error.message);
                setTimeout(() => {
                    btn.style.background = "#28a745";
                    btn.innerHTML = btnOriginalHTML;
                }, 2000);
            }
        }

        // --- OTRAS FUNCIONES ---
        function filtrarProductos() {
            const term = document.getElementById('busqueda').value.toLowerCase();
            document.querySelectorAll('.fila-producto').forEach(fila => {
                fila.style.display = fila.dataset.search.toLowerCase().includes(term) ? "" : "none";
            });
        }

        function actualizarEstadisticas(prods) {
            document.getElementById('stat-total-prods').innerHTML = `<strong>Total Variantes:</strong> ${prods.length}`;
            document.getElementById('stat-low-stock').innerHTML = `<strong>‚ö†Ô∏è Bajo Stock:</strong> ${prods.filter(p => p.stock < 5).length}`;
        }

        function exportarExcel() {
            const dataExcel = productosLocal.map(p => ({
                Producto: p.titulo,
                Talla: p.talla,
                Color: p.color,
                Stock: p.stock,
                Precio: p.precio,
                Imagen: p.imagen
            }));
            const worksheet = XLSX.utils.json_to_sheet(dataExcel);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, "Inventario");
            XLSX.writeFile(workbook, "Inventario_Gruken.xlsx");
        }

        function exportarPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            doc.text("Reporte de Inventario - Gruken", 14, 15);
            doc.setFontSize(10);
            doc.text(`Fecha: ${new Date().toLocaleDateString()}`, 14, 22);

            const body = productosLocal.map(p => [p.titulo, `${p.talla} / ${p.color}`, p.stock, `$${p.precio}`]);
            
            doc.autoTable({
                startY: 30,
                head: [['Producto', 'Variante', 'Stock', 'Precio']],
                body: body,
                theme: 'striped',
                headStyles: { fillColor: [51, 51, 51] }
            });

            doc.save("Inventario_Gruken.pdf");
        }
    </script>
</body>
</html>