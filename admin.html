<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Administraci√≥n</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        /* ESTILOS GENERALES Y LIMPIOS */
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; padding: 10px; background: #f4f4f4; margin: 0; }
        .container { max-width: 1200px; margin: auto; background: #ffffff; padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        
        /* BARRA SUPERIOR DE PESTA√ëAS */
        .top-bar { display: flex; gap: 10px; border-bottom: 2px solid #eee; padding-bottom: 15px; margin-bottom: 20px; flex-wrap: wrap; }
        .tab-btn { background: #eee; border: none; padding: 10px 20px; border-radius: 8px; font-weight: bold; cursor: pointer; transition: 0.3s; color: #555; display: flex; align-items: center; gap: 8px; }
        .tab-btn:hover { background: #ddd; }
        .tab-btn.active { background: #333; color: white; }
        .tab-btn-add { background: #007bff; color: white; }
        .tab-btn-add:hover { background: #0056b3; }
        
        /* OCULTAR/MOSTRAR SECCIONES */
        .view-section { display: none; animation: fadeIn 0.3s ease-in-out; }
        .view-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        /* FORMULARIOS Y TABLAS */
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 15px; }
        .form-input { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box; }
        .btn-save { margin-top: 15px; padding: 10px 20px; background: #28a745; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; width: 100%; font-size: 16px; transition: 0.3s; }
        .btn-save:hover { background: #218838; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 15px; text-align: left; }
        th, td { padding: 12px; border-bottom: 1px solid #eee; vertical-align: middle; }
        th { background: #333; color: white; }
        .btn-delete { background: #dc3545; color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer; }
        .btn-delete:hover { background: #c82333; }
        
        /* RESPONSIVO PARA CELULARES */
        @media (max-width: 768px) {
            thead { display: none; }
            tr { display: block; border: 1px solid #ddd; margin-bottom: 10px; border-radius: 8px; padding: 10px; }
            td { display: flex; justify-content: space-between; border-bottom: 1px dashed #eee; align-items: center; }
            td::before { content: attr(data-label); font-weight: bold; color: #555; }
            .form-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

    <div id="pantalla-login" style="position: fixed; top: 0; left: 0; width: 100%; height: 100vh; background: #222; z-index: 10000; display: flex; justify-content: center; align-items: center;">
        <div style="background: white; padding: 30px; border-radius: 12px; text-align: center; width: 90%; max-width: 350px;">
            <h2>üîê Acceso a Gruken</h2>
            <input type="email" id="email-admin" placeholder="Correo" class="form-input" style="margin-bottom:10px;">
            <input type="password" id="pass-admin" placeholder="Contrase√±a" class="form-input" style="margin-bottom:15px;">
            <button onclick="iniciarSesion()" class="btn-save" style="margin-top:0;">Entrar al Inventario</button>
        </div>
    </div>

    <div class="container">
        
        <div class="top-bar">
            <button class="tab-btn active" onclick="cambiarPestana('vista-inventario', this)"><i class="fas fa-box"></i> Mi Inventario</button>
            <button class="tab-btn tab-btn-add" onclick="cambiarPestana('vista-agregar', this)"><i class="fas fa-plus"></i> Agregar Producto</button>
            <button class="tab-btn" onclick="cambiarPestana('vista-ventas', this)"><i class="fas fa-chart-line"></i> Ventas</button>
            <button class="tab-btn" onclick="cambiarPestana('vista-configuracion', this)"><i class="fas fa-cog"></i> Configuraci√≥n</button>
        </div>

        <div id="vista-inventario" class="view-section active">
            <h3 style="margin-top:0;"><i class="fas fa-list"></i> Lista de Productos</h3>
            <div style="overflow-x: auto;">
                <table>
                    <thead>
                        <tr>
                            <th>Imagen</th>
                            <th>ID</th>
                            <th>Nombre</th>
                            <th>Talles</th>
                            <th>Colores</th>
                            <th>Stock</th>
                            <th>Precio</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="cuerpo-inventario">
                        <tr><td colspan="8">Cargando inventario...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div id="vista-agregar" class="view-section">
            <h3 style="margin-top:0;"><i class="fas fa-plus-circle"></i> Datos del Producto</h3>
            <div class="form-grid">
                <div><label><b>ID (Ej: ART-01):</b></label><input type="text" id="prod-id" class="form-input" placeholder="Identificador √∫nico"></div>
                <div><label><b>Nombre:</b></label><input type="text" id="prod-nombre" class="form-input" placeholder="Ej: Buzo Osito"></div>
                <div><label><b>Talles:</b></label><input type="text" id="prod-talles" class="form-input" placeholder="Ej: S, M, L, XL"></div>
                <div><label><b>Colores:</b></label><input type="text" id="prod-colores" class="form-input" placeholder="Ej: Rosa, Negro"></div>
                <div><label><b>Stock Total:</b></label><input type="number" id="prod-stock" class="form-input" placeholder="0"></div>
                <div><label><b>Precio ($):</b></label><input type="number" id="prod-precio" class="form-input" placeholder="0.00"></div>
                <div style="grid-column: 1 / -1;"><label><b>URL de la Imagen:</b></label><input type="text" id="prod-img" class="form-input" placeholder="Ej: images/buzo.jpg"></div>
            </div>
            <button onclick="guardarProductoUnificado()" class="btn-save"><i class="fas fa-save"></i> Guardar Producto</button>
        </div>

        <div id="vista-ventas" class="view-section">
            <h3 style="margin-top:0;"><i class="fas fa-history"></i> Historial de Ventas</h3>
            <div style="overflow-x: auto;">
                <div id="tabla-historial-ventas">Cargando ventas...</div>
            </div>
        </div>

        <div id="vista-configuracion" class="view-section">
            <h3 style="margin-top:0;"><i class="fas fa-tools"></i> Ajustes Generales y Redes</h3>
            <div class="form-grid">
                <div><label>Nombre de la P√°gina:</label><input type="text" id="config-nombre" class="form-input"></div>
                <div><label>P√°gina Web (Link):</label><input type="text" id="config-web" class="form-input"></div>
                <div><label>Logo (Ruta):</label><input type="text" id="config-logo" class="form-input"></div>
                <div><label>Favicon (Icono pesta√±a):</label><input type="text" id="config-favicon" class="form-input"></div>
                <div><label>WhatsApp:</label><input type="text" id="config-wsp" class="form-input"></div>
                <div><label>Correo Electr√≥nico:</label><input type="email" id="config-email" class="form-input"></div>
                <div><label>Enlace de TikTok:</label><input type="text" id="config-tiktok" class="form-input"></div>
                <div><label>Enlace de Facebook:</label><input type="text" id="config-facebook" class="form-input"></div>
                <div><label>Enlace de Instagram:</label><input type="text" id="config-instagram" class="form-input"></div>
                <div><label>Enlace de YouTube:</label><input type="text" id="config-youtube" class="form-input"></div>
            </div>
            <button onclick="guardarConfiguracion()" class="btn-save" style="background: #007bff;"><i class="fas fa-cloud-upload-alt"></i> Guardar Configuraci√≥n</button>
        </div>

    </div>

    <script>
        // 1. CONEXI√ìN A LA BASE DE DATOS
        const supabaseUrl = 'https://pvniwivsxluujijyqqpc.supabase.co';
        const supabaseKey = 'sb_publishable_ss0VcJwu1wR5OVrNn2aYUw_sGG4HiJh';
        const _supabase = supabase.createClient(supabaseUrl, supabaseKey);

        // 2. SISTEMA DE LOGIN Y CARGA INICIAL
        async function iniciarSesion() {
            const email = document.getElementById('email-admin').value;
            const password = document.getElementById('pass-admin').value;
            const { error } = await _supabase.auth.signInWithPassword({ email, password });

            if (error) {
                alert("Acceso denegado ‚ùå Revisa tu correo o contrase√±a.");
            } else {
                document.getElementById('pantalla-login').style.display = 'none';
                cargarInventarioUnificado();
                cargarVentas();
                cargarConfiguracion();
            }
        }

        // Si el usuario ya hab√≠a iniciado sesi√≥n, no le pedimos la clave de nuevo
        document.addEventListener('DOMContentLoaded', () => {
            _supabase.auth.getSession().then(({ data: { session } }) => {
                if (session) {
                    document.getElementById('pantalla-login').style.display = 'none';
                    cargarInventarioUnificado();
                    cargarVentas();
                    cargarConfiguracion();
                }
            });
        });

        // 3. FUNCI√ìN PARA CAMBIAR ENTRE PESTA√ëAS
        function cambiarPestana(idVista, btnElement) {
            // Ocultamos todo
            document.querySelectorAll('.view-section').forEach(v => v.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            
            // Mostramos lo seleccionado
            document.getElementById(idVista).classList.add('active');
            if(btnElement) btnElement.classList.add('active');
        }

        // 4. L√ìGICA DEL INVENTARIO (LEER Y MOSTRAR)
        async function cargarInventarioUnificado() {
            const { data, error } = await _supabase.from('productos').select('*').order('id', { ascending: true });
            const tbody = document.getElementById('cuerpo-inventario');
            
            if (error) {
                tbody.innerHTML = `<tr><td colspan="8" style="color:red;">Error: ${error.message}</td></tr>`;
                return;
            }

            if(data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;">No tienes productos a√∫n. ¬°Ve a Agregar Producto!</td></tr>';
                return;
            }

            tbody.innerHTML = ''; 
            data.forEach(prod => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td data-label="Imagen"><img src="${prod.imagen || ''}" width="40" style="border-radius: 5px; border: 1px solid #ddd; object-fit: cover;"></td>
                    <td data-label="ID"><b>${prod.id}</b></td>
                    <td data-label="Nombre">${prod.nombre || ''}</td>
                    <td data-label="Talles">${prod.talles || ''}</td>
                    <td data-label="Colores">${prod.colores || ''}</td>
                    <td data-label="Stock"><b>${prod.stock || 0}</b></td>
                    <td data-label="Precio">$${(prod.precio || 0).toLocaleString()}</td>
                    <td data-label="Acciones">
                        <button onclick="eliminarProducto('${prod.id}')" class="btn-delete" title="Eliminar producto"><i class="fas fa-trash"></i></button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        // 5. L√ìGICA DEL INVENTARIO (GUARDAR NUEVO O EDITAR)
        async function guardarProductoUnificado() {
            const idProd = document.getElementById('prod-id').value;
            if (!idProd) { alert("¬°Por favor, escribe un ID para el producto!"); return; }

            const nuevoProducto = {
                id: idProd,
                nombre: document.getElementById('prod-nombre').value,
                talles: document.getElementById('prod-talles').value,
                colores: document.getElementById('prod-colores').value,
                stock: parseInt(document.getElementById('prod-stock').value) || 0,
                precio: parseFloat(document.getElementById('prod-precio').value) || 0,
                imagen: document.getElementById('prod-img').value
            };

            const { error } = await _supabase.from('productos').upsert(nuevoProducto);

            if (error) {
                alert("Hubo un error al guardar: " + error.message);
            } else {
                alert("‚úÖ ¬°Producto guardado correctamente!");
                // Limpiar el formulario
                document.querySelectorAll('#vista-agregar .form-input').forEach(input => input.value = '');
                
                // Recargar tabla y llevar al usuario a la pesta√±a de Inventario autom√°ticamente
                cargarInventarioUnificado(); 
                cambiarPestana('vista-inventario', document.querySelector('.tab-btn')); 
            }
        }

        // 6. L√ìGICA DEL INVENTARIO (ELIMINAR)
        async function eliminarProducto(idProd) {
            if (confirm(`¬øEst√°s seguro de eliminar el producto: ${idProd}?`)) {
                const { error } = await _supabase.from('productos').delete().eq('id', idProd);
                if (error) alert("Error al eliminar: " + error.message);
                else cargarInventarioUnificado();
            }
        }

        // 7. L√ìGICA DE CONFIGURACI√ìN DE LA TIENDA
        async function cargarConfiguracion() {
            const { data, error } = await _supabase.from('configuracion').select('*').eq('id', 1).single();
            if (data) {
                document.getElementById('config-nombre').value = data.nombre || '';
                document.getElementById('config-logo').value = data.logo || '';
                document.getElementById('config-wsp').value = data.wsp || '';
                document.getElementById('config-email').value = data.email || '';
                document.getElementById('config-favicon').value = data.favicon || '';
                document.getElementById('config-web').value = data.web || '';
                document.getElementById('config-tiktok').value = data.tiktok || '';
                document.getElementById('config-facebook').value = data.facebook || '';
                document.getElementById('config-instagram').value = data.instagram || '';
                document.getElementById('config-youtube').value = data.youtube || '';
            }
        }

        async function guardarConfiguracion() {
            const config = {
                id: 1, 
                nombre: document.getElementById('config-nombre').value,
                logo: document.getElementById('config-logo').value,
                wsp: document.getElementById('config-wsp').value,
                email: document.getElementById('config-email').value,
                favicon: document.getElementById('config-favicon').value,
                web: document.getElementById('config-web').value,
                tiktok: document.getElementById('config-tiktok').value,
                facebook: document.getElementById('config-facebook').value,
                instagram: document.getElementById('config-instagram').value,
                youtube: document.getElementById('config-youtube').value
            };
            const { error } = await _supabase.from('configuracion').upsert(config);
            if (error) alert('Error al guardar: ' + error.message);
            else alert('‚úÖ ¬°Configuraci√≥n guardada en el servidor!');
        }

        // 8. L√ìGICA DE VENTAS
        async function cargarVentas() {
            const { data, error } = await _supabase.from('ventas').select('*').order('id', { ascending: false });
            const divVentas = document.getElementById('tabla-historial-ventas');
            if (error || !data || data.length === 0) {
                divVentas.innerHTML = "<p>A√∫n no hay ventas registradas.</p>"; return;
            }
            let html = `<table><thead><tr><th>ID</th><th>Fecha</th><th>Cliente</th><th>Total</th></tr></thead><tbody>`;
            data.forEach((v) => {
                let fecha = v.created_at ? new Date(v.created_at).toLocaleDateString() : 'N/A';
                html += `<tr>
                    <td data-label="ID Venta">#${v.id}</td><td data-label="Fecha">${fecha}</td>
                    <td data-label="Cliente"><strong>${v.cliente || 'An√≥nimo'}</strong></td>
                    <td data-label="Total">$${(v.total || 0).toLocaleString('es-AR')}</td>
                </tr>`;
            });
            divVentas.innerHTML = html + '</tbody></table>';
        }
    </script>
</body>
</html>