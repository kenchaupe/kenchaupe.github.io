<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Administraci√≥n</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

    <style>
        :root {
            --primary: #333; --success: #28a745; --warning: #ffc107; --danger: #dc3545; --light: #f4f4f4;
        }
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            padding: 10px; background: #f4f4f4 !important; color: #333; margin: 0; 
        }
        .container { 
            max-width: 1200px; margin: auto; background: #ffffff !important; 
            padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); 
        }

        /* --- MEN√ö DE PESTA√ëAS Y HERRAMIENTAS --- */
        .top-bar { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid var(--light); padding-bottom: 15px; margin-bottom: 20px; flex-wrap: wrap; gap: 10px; }
        .tabs { display: flex; gap: 10px; }
        .tab-btn { background: #eee; border: none; padding: 10px 20px; border-radius: 8px; font-weight: bold; cursor: pointer; transition: 0.3s; color: #555; }
        .tab-btn.active { background: var(--primary); color: white; }
        
        .toolbar-buttons { display: flex; gap: 8px; flex-wrap: wrap; }
        .btn { border: none; padding: 10px 15px; border-radius: 5px; cursor: pointer; color: white; font-weight: bold; display: flex; align-items: center; gap: 5px; transition: 0.3s; }
        .btn:hover { opacity: 0.8; }
        .btn-add { background: #007bff; }
        .btn-excel { background: #1d6f42; }
        .btn-pdf { background: #b30b00; }
        .btn-logout { background: var(--danger); }

        /* --- VISTAS (Pesta√±as) --- */
        .view-section { display: none; }
        .view-section.active { display: block; }

        .stats-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .card { padding: 15px; border-radius: 8px; border-left: 5px solid var(--primary); background: #f9f9f9; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .search-bar { margin-bottom: 20px; display: flex; gap: 10px; }
        input[type="text"], input[type="number"] { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box; }

        /* --- TABLAS Y DISE√ëO RESPONSIVE --- */
        .table-responsive { width: 100%; overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; background: white; min-width: 900px; }
        th, td { padding: 10px; border-bottom: 1px solid #eee; text-align: left; vertical-align: middle; }
        th { background: var(--primary); color: white; font-size: 14px; }
        
        .img-preview { width: 40px; height: 40px; object-fit: cover; border-radius: 4px; margin-right: 5px; border: 1px solid #ddd; }
        .btn-update { background: var(--success); color: white; border: none; padding: 8px 12px; cursor: pointer; border-radius: 4px; font-weight: bold; width: 100%; }

        /* --- MODAL NUEVO PRODUCTO --- */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999; justify-content: center; align-items: center; }
        .modal-content { background: white; padding: 25px; border-radius: 12px; width: 90%; max-width: 400px; display: flex; flex-direction: column; gap: 10px; }
        .modal-content h3 { margin-top: 0; text-align: center; }

        @media (max-width: 768px) {
            .container { padding: 10px; }
            .top-bar { flex-direction: column; align-items: stretch; }
            .tabs { display: grid; grid-template-columns: 1fr 1fr; }
            .toolbar-buttons { display: grid; grid-template-columns: 1fr 1fr; }
            
            thead { display: none; }
            table, tbody, tr, td { display: block; width: 100%; }
            tr { background: #fff; margin-bottom: 15px; border-radius: 8px; padding: 10px; border: 1px solid #ddd; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
            td { text-align: left; padding: 8px 0; border-bottom: 1px dashed #eee; display: flex; flex-direction: column; }
            td::before { content: attr(data-label); font-weight: bold; font-size: 12px; color: #888; margin-bottom: 4px; }
            
            body::-webkit-scrollbar, .table-responsive::-webkit-scrollbar { display: none; }
            body, .table-responsive { -ms-overflow-style: none; scrollbar-width: none; }
        }
    </style>
</head>
<body>

    <div id="pantalla-login" style="position: fixed; top: 0; left: 0; width: 100%; height: 100vh; background: #222; z-index: 10000; display: flex; justify-content: center; align-items: center;">
        <div style="background: white; padding: 30px; border-radius: 12px; text-align: center; width: 90%; max-width: 350px;">
            <h2>üîê Acceso</h2>
            <input type="email" id="email-admin" placeholder="Correo" style="margin-bottom:10px;">
            <input type="password" id="pass-admin" placeholder="Contrase√±a" style="margin-bottom:15px;">
            <button onclick="iniciarSesion()" class="btn btn-update" style="padding:12px;">Entrar</button>
        </div>
    </div>

    <div class="container">
        <div class="top-bar">
            <div class="tabs">
            <button class="tab-btn active" onclick="cambiarPestana('inventario', this)">üì¶ Inventario</button>
            <button class="tab-btn" onclick="cambiarPestana('ventas', this)">üìà Ventas</button>
            <button class="tab-btn" onclick="cambiarPestana('configuracion', this)">‚öôÔ∏è Configuraci√≥n</button>
        </div>
            <div class="toolbar-buttons">
                <button onclick="abrirModalProducto()" class="btn btn-add"><i class="fas fa-plus"></i> Nuevo</button>
                <button onclick="exportarExcel()" class="btn btn-excel"><i class="fas fa-file-excel"></i></button>
                <button onclick="exportarPDF()" class="btn btn-pdf"><i class="fas fa-file-pdf"></i></button>
                <button onclick="cerrarSesion()" class="btn btn-logout"><i class="fas fa-sign-out-alt"></i> Salir</button>
            </div>
        </div>

        <div id="vista-inventario" class="view-section active">
            <div class="stats-cards">
                <div class="card" id="stat-total-prods">Total: -</div>
                <div class="card" id="stat-low-stock" style="border-color:var(--danger);">Bajo Stock: -</div>
            </div>
            <div class="search-bar">
                <input type="text" id="busqueda" placeholder="Buscar producto..." onkeyup="filtrarProductos()">
            </div>
            <div class="table-responsive">
                <div id="tabla-inventario">Cargando...</div>
            </div>
        </div>

        <div id="vista-ventas" class="view-section">
            <div class="search-bar">
                <input type="text" id="busqueda-ventas" placeholder="Buscar por cliente o m√©todo..." onkeyup="filtrarVentas()">
            </div>
            <div class="table-responsive">
                <div id="tabla-historial-ventas">Cargando ventas...</div>
            </div>
        </div>
        <div id="vista-configuracion" class="view-section">
            <div style="background: #fff; padding: 20px; border-radius: 12px; border-top: 3px solid #333;">
                <h2 style="margin-top: 0; margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 10px;">Configuraci√≥n de la Tienda</h2>
                
                <div style="display: flex; flex-direction: column; gap: 15px; max-width: 500px;">
                    <div>
                        <label><b>Nombre de la P√°gina Web:</b></label><br>
                        <input type="text" id="config-nombre" placeholder="Ej: Gruken" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; margin-top: 5px;">
                    </div>
                    <div>
                        <label><b>Logo (Ruta de la imagen):</b></label><br>
                        <input type="text" id="config-logo" placeholder="Ej: images/gruicon.png" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; margin-top: 5px;">
                    </div>
                    <div>
                        <label><b>N√∫mero de WhatsApp:</b></label><br>
                        <input type="text" id="config-wsp" placeholder="Ej: +5491130103905" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; margin-top: 5px;">
                    </div>
                    <div>
                        <label><b>Correo Electr√≥nico:</b></label><br>
                        <input type="email" id="config-email" placeholder="Ej: contacto@gruken.com" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; margin-top: 5px;">
                    </div>
                    <div>
                        <label><b>Icono de la P√°gina (Favicon):</b></label><br>
                      <input type="text" id="config-favicon" placeholder="Ej: images/gruicon.png" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; margin-top: 5px;">
                    </div>
                    <div>
                        <label><b>P√°gina Web:</b></label><br>
                        <input type="text" id="config-web" placeholder="Ej: www.gruken.com" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; margin-top: 5px;">
                    </div>
                    <button onclick="guardarConfiguracion()" class="btn btn-update" style="padding: 12px; margin-top: 10px; justify-content: center; width: 100%;">üíæ Guardar Cambios</button>
                </div>
            </div>
        </div>
    </div>

    <div id="modal-nuevo" class="modal-overlay">
        <div class="modal-content">
            <h3>Agregar Producto</h3>
            <input type="text" id="add-id" placeholder="ID (Ej: vestido-01)">
            <input type="text" id="add-nombre" placeholder="Nombre (Ej: Vestido Lino)">
            <input type="text" id="add-talle" placeholder="Talle">
            <input type="text" id="add-color" placeholder="Color">
            <input type="number" id="add-stock" placeholder="Stock Inicial" value="10">
            <input type="number" id="add-precio" placeholder="Precio ($)">
            <input type="text" id="add-imagen" placeholder="URL de la Imagen">
            <button onclick="guardarNuevoProducto()" id="btn-guardar-nuevo" class="btn btn-update">Guardar Producto</button>
            <button onclick="cerrarModalProducto()" class="btn" style="background:#888; color:white; justify-content:center;">Cancelar</button>
        </div>
    </div>
    
    <script>
        const supabaseUrl = 'https://pvniwivsxluujijyqqpc.supabase.co';
        const supabaseKey = 'sb_publishable_ss0VcJwu1wR5OVrNn2aYUw_sGG4HiJh';
        const _supabase = supabase.createClient(supabaseUrl, supabaseKey);

        let productosLocal = []; 
        let ventasLocal = [];

        // --- NAVEGACI√ìN DE PESTA√ëAS ---
      function cambiarPestana(vista, btn) {
            document.querySelectorAll('.view-section').forEach(v => v.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            
            document.getElementById(`vista-${vista}`).classList.add('active');
            btn.classList.add('active');

            if (vista === 'ventas' && ventasLocal.length === 0) {
                cargarVentas();
            }
            if (vista === 'configuracion') {
                cargarConfiguracionAdmin();
            }
        }

        // --- LOGIN Y SESI√ìN ---
        async function iniciarSesion() {
            const email = document.getElementById('email-admin').value;
            const password = document.getElementById('pass-admin').value;
            const { error } = await _supabase.auth.signInWithPassword({ email, password });

            if (error) {
                alert("Acceso denegado ‚ùå");
            } else {
                document.getElementById('pantalla-login').style.display = 'none';
                cargarInventario();
            }
        }

        async function cerrarSesion() {
            await _supabase.auth.signOut();
            window.location.replace('index.html'); 
        }

        // --- L√ìGICA DE INVENTARIO ---
        async function cargarInventario() {
            const { data, error } = await _supabase.from('productos').select('*').order('nombre', { ascending: true });
            if (error) {
                document.getElementById('tabla-inventario').innerHTML = `<p style="color:red;">Error: ${error.message}</p>`;
                return;
            }
            productosLocal = data;
            renderizarInventario(data);
        }

        function renderizarInventario(productos) {
            let html = `<table><thead><tr>
                <th>Imagen</th><th>Producto</th><th>Talle</th><th>Color</th><th>Stock</th><th>Precio</th><th>Acci√≥n</th>
            </tr></thead><tbody>`;

            productos.forEach((p, index) => {
                const img = p.imagen_url || '';
                const nom = p.nombre || '';
                html += `
                    <tr class="fila-producto" data-search="${nom} ${p.talla} ${p.color}">
                        <td data-label="üñºÔ∏è Imagen">
                            <div style="display:flex; gap:5px;"><img src="${img}" class="img-preview">
                            <input type="text" id="img-${index}" value="${img}"></div>
                        </td>
                        <td data-label="üè∑Ô∏è Nombre"><input type="text" id="nom-${index}" value="${nom}"></td>
                        <td data-label="üìè Talle"><input type="text" id="tal-${index}" value="${p.talla}"></td>
                        <td data-label="üé® Color"><input type="text" id="col-${index}" value="${p.color}"></td>
                        <td data-label="üì¶ Stock"><input type="number" id="stk-${index}" value="${p.stock}"></td>
                        <td data-label="üí≤ Precio"><input type="number" id="pre-${index}" value="${p.precio}"></td>
                        <td data-label="‚öôÔ∏è Acci√≥n">
                            <button class="btn-update" onclick="actualizarProducto(event, ${index}, '${p.id_unico}')"><i class="fas fa-save"></i> Guardar</button>
                        </td>
                    </tr>`;
            });
            document.getElementById('tabla-inventario').innerHTML = html + '</tbody></table>';
            
            document.getElementById('stat-total-prods').innerHTML = `üì¶ <strong>Total:</strong> ${productos.length}`;
            document.getElementById('stat-low-stock').innerHTML = `‚ö†Ô∏è <strong>Bajo Stock:</strong> ${productos.filter(p=>p.stock<5).length}`;
        }

        async function actualizarProducto(event, idx, idUnico) {
            const btn = event.target.closest('button');
            const txtOriginal = btn.innerHTML;
            btn.innerHTML = '...';
            
            const { error } = await _supabase.from('productos').update({ 
                imagen_url: document.getElementById(`img-${idx}`).value,
                nombre: document.getElementById(`nom-${idx}`).value, 
                talla: document.getElementById(`tal-${idx}`).value,
                color: document.getElementById(`col-${idx}`).value,
                stock: parseInt(document.getElementById(`stk-${idx}`).value), 
                precio: parseInt(document.getElementById(`pre-${idx}`).value) 
            }).eq('id_unico', parseInt(idUnico)).select();

            if (!error) {
                btn.style.background = "#2ecc71"; btn.innerHTML = 'Listo';
                setTimeout(() => { btn.style.background = "var(--success)"; btn.innerHTML = txtOriginal; }, 1500);
            } else {
                alert("Error al actualizar: " + error.message);
                btn.innerHTML = txtOriginal;
            }
        }

        function filtrarProductos() {
            const term = document.getElementById('busqueda').value.toLowerCase();
            document.querySelectorAll('.fila-producto').forEach(fila => {
                fila.style.display = fila.dataset.search.toLowerCase().includes(term) ? "" : "none";
            });
        }

        // --- AGREGAR NUEVO PRODUCTO ---
        function abrirModalProducto() { document.getElementById('modal-nuevo').style.display = 'flex'; }
        function cerrarModalProducto() { document.getElementById('modal-nuevo').style.display = 'none'; }

        async function guardarNuevoProducto() {
            const btn = document.getElementById('btn-guardar-nuevo');
            btn.innerHTML = "Guardando...";
            btn.disabled = true;

            const nId = document.getElementById('add-id').value;
            const nNombre = document.getElementById('add-nombre').value;
            const nTalle = document.getElementById('add-talle').value;
            const nColor = document.getElementById('add-color').value;
            const nStock = document.getElementById('add-stock').value;
            const nPrecio = document.getElementById('add-precio').value;
            const nImg = document.getElementById('add-imagen').value;

            const { error } = await _supabase.from('productos').insert([{
                id: nId, nombre: nNombre, talla: nTalle, color: nColor, 
                stock: parseInt(nStock), precio: parseInt(nPrecio), imagen_url: nImg
            }]);

            if (error) {
                alert("Error al guardar: Aseg√∫rate de tener permisos 'INSERT' en Supabase.\n" + error.message);
            } else {
                alert("¬°Producto agregado con √©xito!");
                cerrarModalProducto();
                cargarInventario(); // Recargar tabla
            }
            btn.innerHTML = "Guardar Producto";
            btn.disabled = false;
        }

        // --- L√ìGICA DE VENTAS ---
        async function cargarVentas() {
            document.getElementById('tabla-historial-ventas').innerHTML = "Cargando datos...";
            const { data, error } = await _supabase.from('ventas').select('*').order('id', { ascending: false });
            
            if (error) {
                document.getElementById('tabla-historial-ventas').innerHTML = `<p style="color:red;">Error: ${error.message}<br>¬øTienes la tabla 'ventas' y permisos SELECT habilitados?</p>`;
                return;
            }
            ventasLocal = data;
            renderizarVentas(data);
        }

        function renderizarVentas(ventas) {
            if(ventas.length === 0) {
                document.getElementById('tabla-historial-ventas').innerHTML = "<p>A√∫n no hay ventas registradas.</p>";
                return;
            }

            let html = `<table><thead><tr>
                <th>ID</th><th>Fecha</th><th>Cliente</th><th>M√©todo</th><th>Total</th><th>Detalle</th>
            </tr></thead><tbody>`;

            ventas.forEach((v, idx) => {
                // Formateamos la fecha si existe "created_at"
                let fecha = v.created_at ? new Date(v.created_at).toLocaleDateString() : 'N/A';
                
                // Formateamos los art√≠culos si est√°n guardados como texto JSON
                let articulosHTML = "Ver detalle";
                if(v.articulos) {
                    try {
                        let arts = typeof v.articulos === 'string' ? JSON.parse(v.articulos) : v.articulos;
                        articulosHTML = arts.map(a => `${a.cantidad}x ${a.titulo} (${a.color}/${a.talla})`).join('<br>');
                    } catch(e) { articulosHTML = v.articulos; }
                }

                html += `
                    <tr class="fila-venta" data-search="${v.cliente} ${v.metodo_pago}">
                        <td data-label="ID Venta">#${v.id || idx}</td>
                        <td data-label="üìÖ Fecha">${fecha}</td>
                        <td data-label="üë§ Cliente"><strong>${v.cliente || 'An√≥nimo'}</strong><br><small>${v.direccion || ''}</small></td>
                        <td data-label="üí≥ M√©todo">${v.metodo_pago || 'N/A'}</td>
                        <td data-label="üí∞ Total"><strong>$${(v.total || 0).toLocaleString('es-AR')}</strong></td>
                        <td data-label="üõí Art√≠culos"><small>${articulosHTML}</small></td>
                    </tr>`;
            });
            document.getElementById('tabla-historial-ventas').innerHTML = html + '</tbody></table>';
        }

        function filtrarVentas() {
            const term = document.getElementById('busqueda-ventas').value.toLowerCase();
            document.querySelectorAll('.fila-venta').forEach(fila => {
                fila.style.display = fila.dataset.search.toLowerCase().includes(term) ? "" : "none";
            });
        }

        // --- EXPORTAR ---
        function exportarExcel() {
            const dataExcel = productosLocal.map(p => ({
                Producto: p.nombre, Talla: p.talla, Color: p.color, Stock: p.stock, Precio: p.precio
            }));
            const ws = XLSX.utils.json_to_sheet(dataExcel);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Inventario");
            XLSX.writeFile(wb, "Inventario_Gruken.xlsx");
        }
        function exportarPDF() {
            const { jsPDF } = window.jspdf; const doc = new jsPDF();
            doc.text("Inventario - Gruken", 14, 15);
            const body = productosLocal.map(p => [p.nombre, `${p.talla}/${p.color}`, p.stock, `$${p.precio}`]);
            doc.autoTable({ startY: 25, head: [['Producto', 'Variante', 'Stock', 'Precio']], body: body });
            doc.save("Inventario.pdf");
        }
       // --- CARGAR DATOS AL ENTRAR AL ADMIN ---
async function cargarConfiguracion() {
    const { data, error } = await _supabase.from('configuracion').select('*').eq('id', 1).single();
    if (data) {
        document.getElementById('config-nombre').value = data.nombre || '';
        document.getElementById('config-logo').value = data.logo || '';
        document.getElementById('config-wsp').value = data.wsp || '';
        document.getElementById('config-email').value = data.email || '';
        document.getElementById('config-favicon').value = data.favicon || ''; // Nuevo
        document.getElementById('config-web').value = data.web || ''; // Nuevo
    }
}

// --- GUARDAR CAMBIOS EN SUPABASE ---
async function guardarConfiguracion() {
    const btn = document.querySelector('.btn-update');
    const textoOriginal = btn.textContent;
    btn.textContent = "Guardando en servidor...";
    btn.disabled = true;

    // Usaremos el mismo n√∫mero de WSP para el footer y el flotante
    const config = {
        id: 1, 
        nombre: document.getElementById('config-nombre').value,
        logo: document.getElementById('config-logo').value,
        wsp: document.getElementById('config-wsp').value,
        email: document.getElementById('config-email').value,
        favicon: document.getElementById('config-favicon').value, // Nuevo
        web: document.getElementById('config-web').value // Nuevo
    };
    
    const { error } = await _supabase.from('configuracion').upsert(config);
    
    btn.textContent = textoOriginal;
    btn.disabled = false;

    if (error) {
        alert('Hubo un error al guardar: ' + error.message);
    } else {
        alert('¬°Configuraci√≥n guardada en el servidor correctamente!');
    }
}
    </script>
</body>
</html>


